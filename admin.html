<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySpace - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --admin-bg: #f8fafc; --admin-card: #ffffff; }
        body { background: var(--admin-bg); font-family: 'Inter', sans-serif; }
        .admin-container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        .admin-card { background: var(--admin-card); padding: 30px; border-radius: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 30px; border: 1px solid #e2e8f0; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .admin-table th { background: #f8fafc; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-shipped { background: #dcfce7; color: #16a34a; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .hidden-admin { display: none; }
    </style>
</head>
<body>
    <div id="auth-gate" class="admin-container text-center" style="padding-top:100px;">
        <i class="fa-solid fa-lock" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 20px;"></i>
        <h2>Verifying Administrator Identity...</h2>
        <p>Checking credentials for StudySpace access.</p>
    </div>

    <div id="admin-content" class="admin-container hidden-admin">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1><i class="fa-solid fa-shield-halved" style="color:var(--primary-color)"></i> Admin Panel</h1>
            <a href="index.html" class="btn btn-outline">Exit to Shop</a>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-plus-circle"></i> Add New Product</h3>
            <form id="add-product-form" class="admin-grid">
                <input type="text" id="p-name" class="form-input" placeholder="Product Name" required>
                <input type="number" id="p-price" class="form-input" placeholder="Price ($)" step="0.01" required>
                <select id="p-category" class="form-input">
                    <option value="furniture">Furniture</option>
                    <option value="bedding">Bedding</option>
                    <option value="kitchen">Kitchen</option>
                    <option value="storage">Storage</option>
                </select>
                <input type="number" id="p-stock" class="form-input" placeholder="Initial Stock Quantity" required>
                <input type="text" id="p-image" class="form-input" placeholder="Image URL" style="grid-column: span 2;" required>
                <button type="submit" class="btn btn-primary" style="grid-column: span 2;">Upload to Shop</button>
            </form>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-boxes-stacked"></i> Shop Inventory</h3>
            <div id="admin-product-list"><p>Loading products...</p></div>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-truck-fast"></i> Student Orders</h3>
            <div id="admin-orders-list"><p>Loading orders...</p></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB47wH_KObIIMAksM8TqI7norRmSK0IXnY",
            authDomain: "studyspace-backend.firebaseapp.com",
            projectId: "studyspace-backend",
            storageBucket: "studyspace-backend.firebasestorage.app",
            messagingSenderId: "511542334086",
            appId: "1:511542334086:web:11e4de3014db2966743707",
            measurementId: "G-LFTQWBYXGS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // AUTHORIZED ADMIN EMAIL
        const ADMIN_EMAIL = 'rajkumar.shrestha7025@gmail.com'; 

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                document.getElementById('auth-gate').classList.add('hidden-admin');
                document.getElementById('admin-content').classList.remove('hidden-admin');
                loadProducts();
                loadOrders();
            } else {
                document.getElementById('auth-gate').innerHTML = `
                    <h1 style="color:#ef4444;">Access Denied</h1>
                    <p>Only <strong>${ADMIN_EMAIL}</strong> can access this panel.</p>
                    <a href="signin.html" class="btn btn-primary" style="margin-top:20px;">Sign in as Admin</a>
                `;
            }
        });

        // Add Product Logic
        document.getElementById('add-product-form').onsubmit = async (e) => {
            e.preventDefault();
            const newProduct = {
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value),
                category: document.getElementById('p-category').value,
                stock: parseInt(document.getElementById('p-stock').value),
                image: document.getElementById('p-image').value
            };
            try {
                await addDoc(collection(db, "products"), newProduct);
                alert("Product Added!");
                e.target.reset();
            } catch (err) { alert("Error: " + err.message); }
        };

        function loadProducts() {
            onSnapshot(collection(db, "products"), (snapshot) => {
                const container = document.getElementById('admin-product-list');
                let html = `<table class="admin-table"><thead><tr><th>Img</th><th>Name</th><th>Stock</th><th>Action</th></tr></thead><tbody>`;
                snapshot.forEach(pDoc => {
                    const p = pDoc.data();
                    html += `<tr>
                        <td><img src="${p.image}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;"></td>
                        <td><strong>${p.name}</strong><br>$${p.price.toFixed(2)}</td>
                        <td>${p.stock}</td>
                        <td><button class="btn btn-sm" style="color:#ef4444;background:none;" onclick="deleteProduct('${pDoc.id}')"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
                });
                container.innerHTML = html + `</tbody></table>`;
            });
        }

        window.deleteProduct = async (id) => {
            if(confirm("Delete this product?")) await deleteDoc(doc(db, "products", id));
        };

        function loadOrders() {
            onSnapshot(collection(db, "orders"), (snapshot) => {
                const container = document.getElementById('admin-orders-list');
                let html = `<table class="admin-table"><thead><tr><th>Customer</th><th>Total</th><th>Status</th><th>Action</th></tr></thead><tbody>`;
                snapshot.forEach(oDoc => {
                    const o = oDoc.data();
                    const statusClass = o.status === 'Shipped' ? 'status-shipped' : 'status-pending';
                    html += `<tr>
                        <td>${o.customerName}<br><small>${o.customerEmail}</small></td>
                        <td>$${o.subtotal.toFixed(2)}</td>
                        <td><span class="status-badge ${statusClass}">${o.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="updateOrder('${oDoc.id}', 'Shipped')">Ship</button>
                            <button class="btn btn-sm" style="color:#94a3b8;background:none;" onclick="deleteOrder('${oDoc.id}')"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    </tr>`;
                });
                container.innerHTML = html + `</tbody></table>`;
            });
        }

        window.updateOrder = async (id, status) => { await updateDoc(doc(db, "orders", id), { status }); };
        window.deleteOrder = async (id) => { if(confirm("Delete order?")) await deleteDoc(doc(db, "orders", id)); };
    </script>
</body>
</html>
