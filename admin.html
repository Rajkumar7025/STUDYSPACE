<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySpace - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Admin Specific Styles */
        body { background: #f8fafc; padding-bottom: 50px; }
        .admin-container { max-width: 1000px; margin: 40px auto; padding: 20px; }
        .admin-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* Form Grid */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        /* Table Styles */
        .inventory-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .inventory-table th { text-align: left; padding: 15px; background: #f1f5f9; color: #64748b; font-size: 0.9rem; }
        .inventory-table td { padding: 15px; border-bottom: 1px solid #e2e8f0; }
        .inventory-table img { width: 50px; height: 50px; border-radius: 5px; object-fit: cover; }
        
        /* Login Gate */
        #login-gate { text-align: center; margin-top: 100px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <div class="logo-icon"><i class="fa-solid fa-shield-halved"></i></div>
                <span class="logo-text">Admin Panel</span>
            </div>
            <a href="index.html" class="btn btn-outline">Exit to Shop</a>
        </div>
    </nav>

    <div id="login-gate" class="container">
        <div class="admin-card" style="max-width: 400px; margin: 0 auto;">
            <i class="fa-solid fa-lock" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 20px;"></i>
            <h2>Admin Access Only</h2>
            <p class="mb-8">Sign in with <strong>rajkumar.shrestha7025@gmail.com</strong> to manage the shop.</p>
            <button id="admin-login-btn" class="btn btn-primary full-width">
                <i class="fa-brands fa-google"></i> Sign in with Google
            </button>
        </div>
    </div>

    <div id="admin-content" class="admin-container hidden">
        
        <div class="admin-header">
            <h1><i class="fa-solid fa-chart-line"></i> Dashboard</h1>
            <button id="logout-btn" class="btn btn-sm btn-outline">Log Out</button>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-plus-circle"></i> Add New Product</h3>
            <form id="add-product-form" class="form-grid">
                <input type="text" id="p-name" class="form-input" placeholder="Product Name (e.g. Desk Lamp)" required>
                <input type="number" id="p-price" class="form-input" placeholder="Price ($)" step="0.01" required>
                
                <select id="p-category" class="form-input">
                    <option value="furniture">Furniture</option>
                    <option value="kitchen">Kitchen</option>
                    <option value="bedding">Bedding</option>
                    <option value="storage">Storage</option>
                    <option value="lighting">Lighting</option>
                    <option value="decor">Decor</option>
                </select>
                
                <input type="number" id="p-stock" class="form-input" placeholder="Stock Quantity" required>
                <input type="text" id="p-image" class="form-input full-width" placeholder="Image URL (Right click image -> Copy Image Address)" required>
                
                <button type="submit" class="btn btn-primary full-width">Upload Product</button>
            </form>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-boxes-stacked"></i> Current Inventory</h3>
            <div style="overflow-x: auto;">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // --- A. FIREBASE CONNECTION ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB47wH_KObIIMAksM8TqI7norRmSK0IXnY",
            authDomain: "studyspace-backend.firebaseapp.com",
            projectId: "studyspace-backend",
            storageBucket: "studyspace-backend.firebasestorage.app",
            messagingSenderId: "511542334086",
            appId: "1:511542334086:web:11e4de3014db2966743707",
            measurementId: "G-LFTQWBYXGS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const ADMIN_EMAIL = "rajkumar.shrestha7025@gmail.com";

        // --- B. AUTHENTICATION LOGIC ---
        const loginGate = document.getElementById('login-gate');
        const adminContent = document.getElementById('admin-content');

        document.getElementById('admin-login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                // User is Admin -> Show Dashboard
                loginGate.classList.add('hidden');
                adminContent.classList.remove('hidden');
                loadInventory(); // Start listening for data
            } else if (user) {
                alert("Access Denied: You are not the admin.");
                signOut(auth);
            } else {
                // User is logged out -> Show Lock Screen
                loginGate.classList.remove('hidden');
                adminContent.classList.add('hidden');
            }
        });

        // --- C. ADD PRODUCT ---
        document.getElementById('add-product-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const newProduct = {
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value),
                category: document.getElementById('p-category').value,
                stock: parseInt(document.getElementById('p-stock').value),
                image: document.getElementById('p-image').value,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, "products"), newProduct);
                alert("Product Added Successfully!");
                e.target.reset(); // Clear form
            } catch (error) {
                console.error(error);
                alert("Error: " + error.message);
            }
        };

        // --- D. LOAD INVENTORY (Real-time) ---
        function loadInventory() {
            onSnapshot(collection(db, "products"), (snapshot) => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = ''; // Clear list to prevent duplicates
                
                snapshot.forEach(productDoc => {
                    const p = productDoc.data();
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td><img src="${p.image}" onerror="this.src='https://via.placeholder.com/50'"></td>
                        <td><strong>${p.name}</strong><br><small style="color:#666">${p.category}</small></td>
                        <td>$${p.price}</td>
                        <td>${p.stock}</td>
                        <td>
                            <button class="btn btn-sm" style="background:#fee2e2; color:#ef4444;" onclick="deleteProduct('${productDoc.id}')">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    list.appendChild(row);
                });
            });
        }

        // --- E. DELETE FUNCTION ---
        // We attach this to 'window' so the HTML onclick="" can find it
        window.deleteProduct = async (id) => {
            if(confirm("Are you sure you want to delete this item?")) {
                await deleteDoc(doc(db, "products", id));
            }
        };
    </script>
</body>
</html>
