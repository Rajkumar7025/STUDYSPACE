<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySpace - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Admin Specific Styles */
        body { background: #f1f5f9; padding-bottom: 50px; }
        .admin-container { max-width: 1000px; margin: 40px auto; padding: 20px; }
        .admin-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        .inventory-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .inventory-table th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
        .inventory-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <span class="logo-text">Admin Dashboard</span>
            </div>
            <a href="index.html" class="btn btn-outline">Exit to Shop</a>
        </div>
    </nav>

    <div id="login-gate" class="container" style="text-align:center; margin-top:100px;">
        <div class="admin-card" style="max-width:400px; margin:0 auto;">
            <h2>Admin Login</h2>
            <p style="margin-bottom:20px;">Restricted Access</p>
            <button id="admin-login-btn" class="btn btn-primary full-width">Sign In with Google</button>
        </div>
    </div>

    <div id="admin-content" class="admin-container hidden">
        
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h1>Dashboard</h1>
            <button id="logout-btn" class="btn btn-sm btn-outline">Log Out</button>
        </div>

        <div class="admin-card" style="border-top: 4px solid #a855f7;">
            <h3><i class="fa-solid fa-truck-fast"></i> Student Orders</h3>
            <div style="overflow-x:auto;">
                <table class="inventory-table">
                    <thead><tr><th>Status</th><th>Customer</th><th>Items</th><th>Total</th><th>Action</th></tr></thead>
                    <tbody id="orders-list"></tbody>
                </table>
            </div>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-plus"></i> Add New Product</h3>
            <form id="add-product-form" class="form-grid">
                <input type="text" id="p-name" class="form-input" placeholder="Product Name" required>
                <input type="number" id="p-price" class="form-input" placeholder="Price ($)" step="0.01" required>
                <select id="p-category" class="form-input">
                    <option value="furniture">Furniture</option>
                    <option value="kitchen">Kitchen</option>
                    <option value="bedding">Bedding</option>
                    <option value="storage">Storage</option>
                    <option value="lighting">Lighting</option>
                    <option value="decor">Decor</option>
                </select>
                <input type="number" id="p-stock" class="form-input" placeholder="Stock" required>
                <input type="text" id="p-image" class="form-input full-width" placeholder="Image URL" required>
                <button type="submit" class="btn btn-primary full-width">Add to Shop</button>
            </form>
        </div>

        <div class="admin-card">
            <h3><i class="fa-solid fa-boxes-stacked"></i> Current Inventory</h3>
            <div style="overflow-x:auto;">
                <table class="inventory-table">
                    <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Stock</th><th>Action</th></tr></thead>
                    <tbody id="inventory-list"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB47wH_KObIIMAksM8TqI7norRmSK0IXnY",
            authDomain: "studyspace-backend.firebaseapp.com",
            projectId: "studyspace-backend",
            storageBucket: "studyspace-backend.firebasestorage.app",
            messagingSenderId: "511542334086",
            appId: "1:511542334086:web:11e4de3014db2966743707",
            measurementId: "G-LFTQWBYXGS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // YOUR ADMIN EMAIL
        const ADMIN_EMAIL = "rajkumar.shrestha7025@gmail.com";

        // Auth Logic
        document.getElementById('admin-login-btn').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            const gate = document.getElementById('login-gate');
            const content = document.getElementById('admin-content');
            
            if (user && user.email === ADMIN_EMAIL) {
                gate.classList.add('hidden');
                content.classList.remove('hidden');
                loadData(); // Load Products and Orders
            } else {
                gate.classList.remove('hidden');
                content.classList.add('hidden');
            }
        });

        function loadData() {
            // Load Products
            onSnapshot(collection(db, "products"), (snap) => {
                const list = document.getElementById('inventory-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const p = d.data();
                    list.innerHTML += `<tr>
                        <td><img src="${p.image}" style="width:40px;height:40px;object-fit:cover;"></td>
                        <td>${p.name}</td>
                        <td>$${p.price}</td>
                        <td>${p.stock}</td>
                        <td><button onclick="deleteItem('products', '${d.id}')" style="color:red;border:none;background:none;"><i class="fa-solid fa-trash"></i></button></td>
                    </tr>`;
                });
            });

            // Load Orders
            onSnapshot(collection(db, "orders"), (snap) => {
                const list = document.getElementById('orders-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    const o = d.data();
                    const statusColor = o.status === 'Shipped' ? '#dcfce7' : '#fef3c7';
                    const actionBtn = o.status === 'Pending' 
                        ? `<button class="btn btn-sm" onclick="shipOrder('${d.id}')" style="background:#a855f7;color:white;">Ship</button>` 
                        : `<span style="color:green;">Completed</span>`;
                    
                    list.innerHTML += `<tr>
                        <td><span style="background:${statusColor};padding:4px 8px;border-radius:10px;font-size:0.8rem;">${o.status}</span></td>
                        <td>${o.customerName}</td>
                        <td>${o.items.length} items</td>
                        <td>$${o.total}</td>
                        <td>${actionBtn}</td>
                    </tr>`;
                });
            });
        }

        // Add Product
        document.getElementById('add-product-form').onsubmit = async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "products"), {
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value),
                category: document.getElementById('p-category').value,
                stock: parseInt(document.getElementById('p-stock').value),
                image: document.getElementById('p-image').value
            });
            e.target.reset();
            alert("Product Added!");
        };

        // Global Actions
        window.deleteItem = async (col, id) => {
            if(confirm("Delete this?")) await deleteDoc(doc(db, col, id));
        };
        
        window.shipOrder = async (id) => {
            if(confirm("Mark as Shipped?")) await updateDoc(doc(db, "orders", id), { status: "Shipped" });
        };
    </script>
</body>
</html>
